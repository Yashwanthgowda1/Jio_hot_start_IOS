# Azure DevOps Pipeline for Android + Web Automation Testing
# Tests run in parallel on Android Emulator and Web Browser
# Results are collected in organized artifacts

name: $(Date:yyyyMMdd)$(Rev:.r)-Android-Web-Tests

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - Test/android/**
      - Test/web/**
      - azure-pipelines.yml
      - requirements.txt

# Schedule daily runs at 2 AM UTC
schedules:
  - cron: "0 2 * * *"
    displayName: 'Nightly Automation Tests'
    branches:
      include:
        - main
    always: true

variables:
  pythonVersion: '3.11'
  androidApiLevel: '30'
  androidBuildTools: '30.0.3'
  appiumVersion: '1.22.3'
  
stages:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: BUILD AND SETUP
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - stage: Setup
    displayName: 'Setup and Preparation'
    jobs:
      - job: ValidateSetup
        displayName: 'Validate Configuration'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout Source Code'
            
          - task: UsePythonVersion@0
            displayName: 'Setup Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
              
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo " PIPELINE CONFIGURATION"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "Build Number: $(Build.BuildNumber)"
              echo "Build ID: $(Build.BuildId)"
              echo "Source Branch: $(Build.SourceBranchName)"
              echo "Python Version: $(pythonVersion)"
              echo "Android API Level: $(androidApiLevel)"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            displayName: ' Display Configuration'
            
          - script: |
              echo "Validating test files..."
              if [ ! -d "tests/android" ]; then
                echo " Android test directory not found!"
                exit 1
              fi
              if [ ! -d "tests/web" ]; then
                echo " Web test directory not found!"
                exit 1
              fi
              echo " All test directories found"
            displayName: ' Validate Test Structure'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: PARALLEL TESTING - ANDROID & WEB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - stage: Testing
    displayName: ' Run Automated Tests'
    dependsOn: Setup
    jobs:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # JOB 1: ANDROID TESTING ON EMULATOR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - job: AndroidTests
        displayName: 'Android Emulator Tests'
        pool:
          vmImage: 'macos-latest'  # macOS supports hardware acceleration for emulator
        timeoutInMinutes: 90
        steps:
          - checkout: self
            displayName: ' Checkout Code'
            clean: true

          # Python Setup
          - task: UsePythonVersion@0
            displayName: ' Setup Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          # Install Python Dependencies
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "INSTALLING PYTHON DEPENDENCIES"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              python -m pip install --upgrade pip
              pip install -r requirements.txt
              pip install robotframework-appiumlibrary
              pip list | grep -i robot
              echo " Dependencies installed successfully"
            displayName: ' Install Python Packages'

          # Install Java (required for Android)
          - task: JavaToolInstaller@0
            displayName: ' Install Java JDK 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # Setup Android SDK
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo " SETTING UP ANDROID SDK"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              # Set Android SDK paths
              export ANDROID_HOME=$HOME/Library/Android/sdk
              export PATH=$PATH:$ANDROID_HOME/emulator
              export PATH=$PATH:$ANDROID_HOME/platform-tools
              export PATH=$PATH:$ANDROID_HOME/tools
              export PATH=$PATH:$ANDROID_HOME/tools/bin
              
              echo "Android SDK Location: $ANDROID_HOME"
              
              # Accept licenses
              yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses || true
              
              # Install required packages
              echo "Installing Android SDK packages..."
              $ANDROID_HOME/tools/bin/sdkmanager \
                "platform-tools" \
                "platforms;android-$(androidApiLevel)" \
                "build-tools;$(androidBuildTools)" \
                "emulator" \
                "system-images;android-$(androidApiLevel);google_apis;x86_64"
              
              echo " Android SDK setup complete"
            displayName: ' Setup Android SDK'

          # Create Android Emulator
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo " CREATING ANDROID EMULATOR"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              export ANDROID_HOME=$HOME/Library/Android/sdk
              export PATH=$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools/bin
              
              # Create AVD
              echo "Creating Android Virtual Device..."
              echo "no" | $ANDROID_HOME/tools/bin/avdmanager create avd \
                -n test_emulator \
                -k "system-images;android-$(androidApiLevel);google_apis;x86_64" \
                -d "pixel_3" \
                --force
              
              # List available AVDs
              $ANDROID_HOME/tools/bin/avdmanager list avd
              
              echo " Emulator created successfully"
            displayName: ' Create Android Emulator'

          # Start Android Emulator
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo " STARTING ANDROID EMULATOR"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              export ANDROID_HOME=$HOME/Library/Android/sdk
              export PATH=$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools
              
              # Start emulator in background
              echo "Starting emulator..."
              $ANDROID_HOME/emulator/emulator -avd test_emulator \
                -no-window \
                -no-audio \
                -no-boot-anim \
                -gpu swiftshader_indirect \
                -memory 2048 \
                -cores 2 &
              
              # Wait for emulator to boot
              echo "Waiting for emulator to boot..."
              $ANDROID_HOME/platform-tools/adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
              
              # Verify emulator is running
              $ANDROID_HOME/platform-tools/adb devices
              
              echo "Emulator is ready"
            displayName: ' Start Android Emulator'
            timeoutInMinutes: 15

          # Install Appium
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "INSTALLING APPIUM"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              npm install -g appium@$(appiumVersion)
              appium driver install uiautomator2
              appium --version
              echo "Appium installed successfully"
            displayName: ' Install Appium Server'

          # Start Appium Server
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo " STARTING APPIUM SERVER"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              appium --log-level info > appium.log 2>&1 &
              sleep 5
              echo " Appium server started"
            displayName: ' Start Appium Server'

          # Run Android Tests
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo " RUNNING ANDROID TESTS"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              export ANDROID_HOME=$HOME/Library/Android/sdk
              export PATH=$PATH:$ANDROID_HOME/platform-tools
              
              # Create results directory
              mkdir -p results/android
              
              # Run Robot Framework tests
              robot \
                --outputdir results/android \
                --output android_output.xml \
                --log android_log.html \
                --report android_report.html \
                --xunit android_xunit.xml \
                --loglevel INFO \
                --variable PLATFORM:Android \
                --variable DEVICE_NAME:test_emulator \
                --consolecolors on \
                --listener RetryFailed:1 \
                tests/android/ || true
              
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo " ANDROID TEST SUMMARY"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              if [ -f results/android/android_output.xml ]; then
                PASSED=$(grep -oP 'pass="\K[0-9]+' results/android/android_output.xml | head -1 || echo "0")
                FAILED=$(grep -oP 'fail="\K[0-9]+' results/android/android_output.xml | head -1 || echo "0")
                echo " Tests Passed: $PASSED"
                echo " Tests Failed: $FAILED"
              fi
              
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            displayName: 'ðŸ§ª Execute Android Tests'
            continueOnError: true

          # Capture Emulator Screenshot on Failure
          - script: |
              export ANDROID_HOME=$HOME/Library/Android/sdk
              export PATH=$PATH:$ANDROID_HOME/platform-tools
              mkdir -p results/android/screenshots
              adb exec-out screencap -p > results/android/screenshots/emulator_final_state.png || true
            displayName: ' Capture Emulator Screenshot'
            condition: always()

          # Stop Emulator
          - script: |
              export ANDROID_HOME=$HOME/Library/Android/sdk
              export PATH=$PATH:$ANDROID_HOME/platform-tools
              adb emu kill || true
            displayName: ' Stop Android Emulator'
            condition: always()

          # Publish Android Test Results
          - task: PublishTestResults@2
            displayName: ' Publish Android Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'results/android/android_xunit.xml'
              testRunTitle: 'ðŸ“± Android Emulator Tests'
              failTaskOnFailedTests: false
              publishRunAttachments: true

          # Publish Android Artifacts
          - task: PublishBuildArtifacts@1
            displayName: ' Publish Android Artifacts'
            condition: always()
            inputs:
              PathtoPublish: 'results/android'
              ArtifactName: 'ðŸ“±-Android-Test-Results'
              publishLocation: 'Container'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # JOB 2: WEB BROWSER TESTING
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - job: WebTests
        displayName: 'ðŸŒ Web Browser Tests'
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 60
        steps:
          - checkout: self
            displayName: 'ðŸ“¥ Checkout Code'
            clean: true

          # Python Setup
          - task: UsePythonVersion@0
            displayName: 'ðŸ Setup Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          # Install Chrome
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸŒ INSTALLING GOOGLE CHROME"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
              sudo apt-get update
              sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
              google-chrome --version
              echo "âœ… Chrome installed successfully"
            displayName: 'ðŸŒ Install Google Chrome'

          # Install ChromeDriver
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸš— INSTALLING CHROMEDRIVER"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d '.' -f 1)
              echo "Chrome version: $CHROME_VERSION"
              
              CHROMEDRIVER_VERSION=$(wget -qO- "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
              echo "ChromeDriver version: $CHROMEDRIVER_VERSION"
              
              wget -q "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
              unzip -q chromedriver_linux64.zip
              sudo mv chromedriver /usr/local/bin/
              sudo chmod +x /usr/local/bin/chromedriver
              chromedriver --version
              
              rm chromedriver_linux64.zip
              echo "âœ… ChromeDriver installed successfully"
            displayName: 'ðŸš— Install ChromeDriver'

          # Install Xvfb (Virtual Display)
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ–¥ï¸  INSTALLING XVFB"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              sudo apt-get install -y xvfb
              echo "âœ… Xvfb installed successfully"
            displayName: 'ðŸ–¥ï¸ Install Xvfb'

          # Install Python Dependencies
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ“¦ INSTALLING PYTHON DEPENDENCIES"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              python -m pip install --upgrade pip
              pip install -r requirements.txt
              pip list | grep -i robot
              echo "âœ… Dependencies installed successfully"
            displayName: 'ðŸ“¦ Install Python Packages'

          # Verify Installations
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âœ… VERIFYING INSTALLATIONS"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "Python: $(python --version)"
              echo "Robot Framework: $(robot --version)"
              echo "Chrome: $(google-chrome --version)"
              echo "ChromeDriver: $(chromedriver --version)"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            displayName: 'âœ… Verify Installations'

          # Start Xvfb
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ–¥ï¸  STARTING VIRTUAL DISPLAY"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              export DISPLAY=:99
              Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
              sleep 3
              echo "âœ… Virtual display started on :99"
            displayName: 'ðŸ–¥ï¸ Start Virtual Display'

          # Run Web Tests
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ§ª RUNNING WEB TESTS"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              export DISPLAY=:99
              
              # Create results directory
              mkdir -p results/web
              
              # Run Robot Framework tests
              robot \
                --outputdir results/web \
                --output web_output.xml \
                --log web_log.html \
                --report web_report.html \
                --xunit web_xunit.xml \
                --loglevel INFO \
                --variable BROWSER:headlesschrome \
                --variable PLATFORM:Web \
                --consolecolors on \
                --listener RetryFailed:1 \
                tests/web/ || true
              
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ“Š WEB TEST SUMMARY"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              if [ -f results/web/web_output.xml ]; then
                PASSED=$(grep -oP 'pass="\K[0-9]+' results/web/web_output.xml | head -1 || echo "0")
                FAILED=$(grep -oP 'fail="\K[0-9]+' results/web/web_output.xml | head -1 || echo "0")
                echo "âœ… Tests Passed: $PASSED"
                echo "âŒ Tests Failed: $FAILED"
              fi
              
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            displayName: 'ðŸ§ª Execute Web Tests'
            continueOnError: true

          # Publish Web Test Results
          - task: PublishTestResults@2
            displayName: 'ðŸ“Š Publish Web Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'results/web/web_xunit.xml'
              testRunTitle: 'ðŸŒ Web Browser Tests'
              failTaskOnFailedTests: false
              publishRunAttachments: true

          # Publish Web Artifacts
          - task: PublishBuildArtifacts@1
            displayName: 'ðŸ“¦ Publish Web Artifacts'
            condition: always()
            inputs:
              PathtoPublish: 'results/web'
              ArtifactName: 'ðŸŒ-Web-Test-Results'
              publishLocation: 'Container'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: CONSOLIDATE RESULTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - stage: ReportGeneration
    displayName: 'ðŸ“Š Generate Combined Reports'
    dependsOn: Testing
    condition: always()
    jobs:
      - job: ConsolidateResults
        displayName: 'ðŸ“‹ Consolidate All Test Results'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'ðŸ“¥ Checkout Code'

          - task: UsePythonVersion@0
            displayName: 'ðŸ Setup Python'
            inputs:
              versionSpec: '$(pythonVersion)'

          # Download Android Artifacts
          - task: DownloadBuildArtifacts@1
            displayName: 'ðŸ“¥ Download Android Results'
            continueOnError: true
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'ðŸ“±-Android-Test-Results'
              downloadPath: '$(System.ArtifactsDirectory)'

          # Download Web Artifacts
          - task: DownloadBuildArtifacts@1
            displayName: 'ðŸ“¥ Download Web Results'
            continueOnError: true
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'ðŸŒ-Web-Test-Results'
              downloadPath: '$(System.ArtifactsDirectory)'

          # Install Robot Framework
          - script: |
              pip install robotframework robotframework-metrics
            displayName: 'ðŸ“¦ Install Robot Framework'

          # Merge Results
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ”„ MERGING TEST RESULTS"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              mkdir -p consolidated_results
              
              # Copy all results
              cp -r "$(System.ArtifactsDirectory)/ðŸ“±-Android-Test-Results/"* consolidated_results/ 2>/dev/null || echo "No Android results"
              cp -r "$(System.ArtifactsDirectory)/ðŸŒ-Web-Test-Results/"* consolidated_results/ 2>/dev/null || echo "No Web results"
              
              # Merge XML outputs
              rebot \
                --outputdir consolidated_results \
                --output combined_output.xml \
                --log combined_log.html \
                --report combined_report.html \
                --name "Android + Web Test Results" \
                consolidated_results/*_output.xml 2>/dev/null || echo "Merge skipped"
              
              echo "âœ… Results merged successfully"
            displayName: 'ðŸ”„ Merge Test Results'
            continueOnError: true

          # Generate Metrics Dashboard
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ“ˆ GENERATING METRICS DASHBOARD"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              cd consolidated_results
              robotmetrics --inputpath . || echo "Metrics generation skipped"
              
              echo "âœ… Metrics dashboard generated"
            displayName: 'ðŸ“ˆ Generate Test Metrics'
            continueOnError: true

          # Create Summary Report
          - script: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ“‹ FINAL TEST SUMMARY"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              cd consolidated_results
              
              # Extract statistics
              if [ -f combined_output.xml ]; then
                TOTAL_PASSED=$(grep -oP 'pass="\K[0-9]+' combined_output.xml | head -1 || echo "0")
                TOTAL_FAILED=$(grep -oP 'fail="\K[0-9]+' combined_output.xml | head -1 || echo "0")
                TOTAL_TESTS=$((TOTAL_PASSED + TOTAL_FAILED))
                
                echo ""
                echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                echo "â”‚      COMBINED TEST RESULTS             â”‚"
                echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
                echo "â”‚ Total Tests:    $TOTAL_TESTS"
                echo "â”‚ âœ… Passed:       $TOTAL_PASSED"
                echo "â”‚ âŒ Failed:       $TOTAL_FAILED"
                echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                echo ""
                
                # Create summary file
                cat > TEST_SUMMARY.md << EOF
              # Test Execution Summary
              
              **Build**: $(Build.BuildNumber)
              **Date**: $(date)
              **Branch**: $(Build.SourceBranchName)
              
              ## Overall Results
              - **Total Tests**: $TOTAL_TESTS
              - **Passed**: $TOTAL_PASSED âœ…
              - **Failed**: $TOTAL_FAILED âŒ
              - **Pass Rate**: $(awk "BEGIN {printf \"%.2f%%\", ($TOTAL_PASSED/$TOTAL_TESTS)*100}")
              
              ## Platform Breakdown
              - ðŸ“± Android Tests: Check android_report.html
              - ðŸŒ Web Tests: Check web_report.html
              - ðŸ“Š Combined Report: Check combined_report.html
              
              ## Artifacts
              All test results, logs, and screenshots are available in the pipeline artifacts.
              EOF
                
                cat TEST_SUMMARY.md
              fi
              
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            displayName: 'ðŸ“‹ Generate Summary Report'
            condition: always()

          # Publish Combined Results
          - task: PublishBuildArtifacts@1
            displayName: 'ðŸ“¦ Publish Combined Results'
            condition: always()
            inputs:
              PathtoPublish: 'consolidated_results'
              ArtifactName: 'ðŸ“Š-FINAL-Combined-Results'
              publishLocation: 'Container'

          # Upload to Azure Blob Storage (Optional)
          - task: AzureCLI@2
            displayName: 'â˜ï¸ Upload to Azure Blob Storage'
            condition: always()
            continueOnError: true
            inputs:
              azureSubscription: 'AzureStorageConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
                BUILD_ID=$(Build.BuildId)
                
                az storage blob upload-batch \
                  --destination "test-results/$TIMESTAMP-$BUILD_ID" \
                  --source consolidated_results/ \
                  --account-name yourstorageaccount \
                  --overwrite
                
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "â˜ï¸  Results uploaded to Azure Blob Storage"
                echo "View at: https://yourstorageaccount.blob.core.windows.net/test-results/$TIMESTAMP-$BUILD_ID/combined_report.html"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"