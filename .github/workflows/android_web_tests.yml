name: Android + Web Automation Tests

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - "Test/**"
      - ".github/workflows/android_web_tests.yml"
      - "requirements.txt"

  schedule:
    - cron: "0 2 * * *"  # Run daily at 2 AM UTC

jobs:

  # ════════════════════════════════════════
  # JOB 1: ANDROID TESTS (runs on macOS)
  # ════════════════════════════════════════
  android-tests:
    runs-on: macos-latest
    timeout-minutes: 90

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install robotframework-appiumlibrary

      - name: Install Java JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"

      - name: Setup Android SDK
        run: |
          echo "Setting up Android SDK..."
          echo "y" | sudo $ANDROID_HOME/tools/bin/sdkmanager --licenses || true
          sdkmanager "platform-tools" \
                     "platforms;android-30" \
                     "build-tools;30.0.3" \
                     "system-images;android-30;google_apis;x86_64" \
                     "emulator"

      - name: Create AVD
        run: |
          echo "no" | avdmanager create avd \
            -n test_emulator \
            -k "system-images;android-30;google_apis;x86_64" \
            -d "pixel_3" --force

      - name: Start Android Emulator
        run: |
          nohup $ANDROID_HOME/emulator/emulator -avd test_emulator \
            -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
          adb wait-for-device
          adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done]'

      - name: Install Appium
        run: |
          npm install -g appium@1.22.3
          appium driver install uiautomator2

      - name: Start Appium Server
        run: |
          nohup appium --log-level info > appium.log 2>&1 &
          sleep 5

      - name: Run Android Tests
        run: |
          mkdir -p results/android
          robot \
            --outputdir results/android \
            --output android_output.xml \
            --log android_log.html \
            --report android_report.html \
            --xunit android_xunit.xml \
            --variable PLATFORM:Android \
            --variable DEVICE_NAME:test_emulator \
            tests/android/ || true

      - name: Upload Android Test Results
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results
          path: results/android

  # ════════════════════════════════════════
  # JOB 2: WEB TESTS (runs on ubuntu)
  # ════════════════════════════════════════
  web-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Chrome
        run: |
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb

      - name: Install ChromeDriver
        run: |
          CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d '.' -f 1)
          DRIVER_VERSION=$(wget -qO- https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION)
          wget https://chromedriver.storage.googleapis.com/${DRIVER_VERSION}/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Install Xvfb
        run: sudo apt install -y xvfb

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start Virtual Display
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &

      - name: Run Web Tests
        run: |
          export DISPLAY=:99
          mkdir -p results/web

          robot \
            --outputdir results/web \
            --output web_output.xml \
            --log web_log.html \
            --report web_report.html \
            --xunit web_xunit.xml \
            --variable BROWSER:headlesschrome \
            --variable PLATFORM:Web \
            tests/web/ || true

      - name: Upload Web Test Results
        uses: actions/upload-artifact@v4
        with:
          name: web-test-results
          path: results/web

  # ════════════════════════════════════════
  # JOB 3: MERGE REPORTS
  # ════════════════════════════════════════
  merge-reports:
    runs-on: ubuntu-latest
    needs: [ android-tests, web-tests ]

    steps:
      - name: Download Android Results
        uses: actions/download-artifact@v4
        with:
          name: android-test-results
          path: merged/android

      - name: Download Web Results
        uses: actions/download-artifact@v4
        with:
          name: web-test-results
          path: merged/web

      - name: Install Robot Framework
        run: |
          pip install robotframework robotframework-metrics

      - name: Merge XML Reports
        run: |
          mkdir -p merged/combined
          rebot \
            --output merged/combined/output.xml \
            --log merged/combined/log.html \
            --report merged/combined/report.html \
            merged/android/*_output.xml \
            merged/web/*_output.xml || true

      - name: Upload Combined Report
        uses: actions/upload-artifact@v4
        with:
          name: combined-report
          path: merged/combined
