name: 'ðŸ”’ Production Security Scan'

# When to run this workflow
on:
  pull_request:                    # Every pull request
  push:
    branches: [main, master]       # Every push to main/master
  schedule:
    - cron: '0 2 * * 1'           # Every Monday at 2 AM (weekly check)

# What this workflow can do
permissions:
  contents: read                   # Read your code
  security-events: write          # Write to Security tab
  actions: read                   # Read workflow info

jobs:
  security:
    name: 'ðŸ”’ Security Check - Secrets, Licenses, Vulnerabilities'
    runs-on: ubuntu-latest
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GET THE CODE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: 'ðŸ“¥ Get Code'
        uses: actions/checkout@v3
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 1: Find Secrets (Passwords, Keys)
      # Will FAIL the build if secrets found
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: 'ðŸ” Check for Secrets'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          format: 'table'
          exit-code: '1'           # FAIL if secrets found âŒ
        continue-on-error: false
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 2: Check Licenses (GPL = Bad)
      # Will FAIL on problematic licenses
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: 'âš–ï¸ Check Licenses'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'license'
          format: 'table'
          exit-code: '1'           # FAIL on policy violation âŒ
        continue-on-error: false
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 3: Find Vulnerabilities (Bugs)
      # Will FAIL for HIGH/CRITICAL bugs
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: 'ðŸ› Check Vulnerabilities'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'           # FAIL if bugs found âŒ
          ignore-unfixed: true     # Only fail for fixable bugs
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 4: Upload to GitHub Security Tab
      # Creates SARIF report and uploads it
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: 'ðŸ›¡ï¸ Generate SARIF Report'
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: 'ðŸ“¤ Upload to Security Tab'
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 5: Save JSON Report as Artifact
      # You can download this later
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: 'ðŸ“Š Generate JSON Report'
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'security-report.json'
      
      - name: 'ðŸ“¥ Upload Report Artifact'
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.json
          retention-days: 30      # Keep for 30 days
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 6: Show Summary
      # Creates nice summary in GitHub UI
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: 'ðŸ“‹ Create Summary'
        if: always()
        run: |
          echo "# ðŸ”’ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## What was checked:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Secrets** - Passwords, API keys, tokens" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Licenses** - GPL, LGPL, proprietary licenses" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Vulnerabilities** - Security bugs (HIGH & CRITICAL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Reports Available:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ **Security Tab**: Check the 'Security' tab for details" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¥ **JSON Report**: Download from 'Artifacts' section below" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Next scheduled scan: Every Monday at 2 AM UTC_" >> $GITHUB_STEP_SUMMARY